---
title: "hw 3"
author: "cathy"
date: "2024-10-13"
output: github_document
---

Load the package that needed for this hw.

```{r, echo = FALSE}
library(tidyverse)
library(ggplot2)
library(knitr)
```


## Problem 1

load data

```{r}
library(ggridges)
library(patchwork)
library(p8105.datasets)
```

```{r}
data("ny_noaa")
summary(ny_noaa)
```

Comment: the data "ny_noaa" has 2595176 observations and 7variables.
the variable includes: id, date, prcp, sno, snwd, tmax, tmin.
Significant amounts of missing data are present, especially for snow depth (snwd) and snowfall (snow), with 591,786 and 381,221 missing records respectively. Precipitation (prcp) also has a notable number of missing entries (145,838).


Create separate variables for year, month, and day.

```{r}
ny_noaa_clean = 
  ny_noaa |> 
  mutate(
    date = as.Date(date), 
    year = year(date),
    month = month(date),
    day = day(date),
    tmax = as.numeric(tmax), 
    tmin = as.numeric(tmin),
    prcp = as.numeric(prcp) / 10,
    snow = as.numeric(snow) / 10 
  ) |> 
    filter(!is.na(snow))

summary(ny_noaa_clean)
```

Comment: the most commonly observed value for snowfall is 0.0, as indicated by the median and the first and third quartiles all being 0.0.
This indecate that in NY, snowfall may not occur frequently.


Make a two-panel plot showing the average max temperature in January and in July in each station across years.

```{r}
avg_noaa_plot =
  ny_noaa_clean |>
  filter(month(date) %in% c(1, 7)) |>
  mutate(month = factor(month(date), levels = c(1, 7), labels = c("January", "July"))) |>
  group_by(id, year = year(date), month) |>
  summarise(avg_tmax = mean(tmax, na.rm = TRUE), .groups = 'drop') |>
  ggplot(aes(x = year, y = avg_tmax, group = id, color = id)) +
  geom_point() + 
  geom_path() +
  facet_wrap(~ month) +
  labs(title = "Average Max Temperature in January and July Across Years",
       x = "Year",
       y = "Average Max Temperature (°C)",
       color = "Station ID") +
  theme_minimal() +
  theme(legend.position = "none") # Remove the legend to clean up the plot

print(avg_noaa_plot)
```

Comment: There's a clear seasonal pattern with higher temperatures in July compared to January, which is expected due to seasonal variations in climate.
There is unusual number for the maximum temperatures are negative.
The plot shows some extreme spikes, particularly in the temperature data for January

```{r}
hexbin_plot =
  ny_noaa_clean |> 
  ggplot(aes(x = tmax, y = tmin)) +
  geom_hex() + 
  labs(title = "Hexbin Plot of Tmax vs Tmin",
       x = "Maximum Temperature (°C)",
       y = "Minimum Temperature (°C)") +
  theme_minimal()


density_plot =
  ny_noaa_clean |> 
  filter(snow > 0, snow < 100) |> 
  ggplot(aes(x = snow, y = as.factor(year))) + 
  geom_density_ridges()

combined_plot =
  density_plot + hexbin_plot

print(combined_plot)

```



## Problem 2

import and clean "nhanes_covar" and "nhanes_accel" data

```{r}
 covar_df =  
   read_csv("data/nhanes_covar.csv", 
             na = c("NA",".",""),
             skip = 4
            ) |> 
   janitor::clean_names() |> 
   filter(age >= 21) |> 
   mutate(
    sex = factor(
      sex, levels = c(1, 2), 
           labels = c("Male", "Female")),
    education = factor(
      education, levels = c(1, 2, 3), 
                 labels = c("Less than High School", "High School Equivalent", "More than High School"))
  ) |> 
  drop_na()

 accel_df =  
   read_csv("data/nhanes_accel.csv", 
             na = c("NA",".","")) |> 
   janitor::clean_names()
```


Merge the 2 dataset into one "merged_df"
```{r}
 merged_df =
   covar_df|> 
   left_join(accel_df, by = "seqn")
```

Produce a reader-friendly table for the number of men and women in each education category

```{r}
 edu_table =
   merged_df |> 
   group_by(sex, education) |> 
   summarise(count = n(), .groups = 'drop') |> 
   pivot_wider(
     names_from = sex,
     values_from = count) |> 
   knitr::kable() 

 edu_table 
```

Comment: for the "Less than High School" and "More than High School" categories, the numbers are almost balanced between males and females.  
There are more males than females with education levels equivalent to high school.


Create a visualization of the age distributions for men and women in each education category. 

```{r}
edu_plot =
  merged_df |> 
  ggplot(aes(x = age, fill = sex)) +
  geom_density(alpha = 0.5) +
  facet_grid(. ~ education) +
  labs(
    title = "Age Distribution by Sex and Education",
    x = "Age", 
    y = "Education")

print(edu_plot)
```

Comment:
1. For Less than High School: The distribution shows peaks around middle age for both males and females, with males having a slightly earlier peak around age 40, and females peaking slightly later.
2. For High School Equivalent: The peak for males is around the late 30s, while females show a broader distribution with a peak around the early 40s.
3. For More than High School: Both genders show a significant peak in their early 30s, and the distribution tails off more gradually as age increases.


Plot these total activities (y-axis) against age (x-axis)
compare men to women and have separate panels for each education level

```{r}
 total_activity_df = 
   merged_df |>
   mutate(
     total_activity = 
       rowSums(across(starts_with("min")), na.rm = TRUE)) |>
  select(seqn, sex, age, bmi, education, total_activity)


 activity_plot =
   total_activity_df |> 
   ggplot(aes(x = age, y = total_activity, color = sex)) +
   geom_point(alpha = 0.5) +  
   geom_smooth(se = FALSE) + 
   facet_wrap(~ education) + 
   labs(
     title = "Total Daily Activity by Age, Sex, and Education Level",
     x = "Age",
     y = "Total Activity",
     color = "Sex") +
  theme_minimal() + 
  theme(legend.position = "bottom")

print(activity_plot)
```

Comment: Across all education levels, the total daily activity tends to peak in around 40-60 years and gradually declines as age increases.
 Males generally show slightly higher activity levels compared to females in the same age and education group.


Make a three-panel plot that shows the 24-hour activity time 
 courses for each education level and use color to indicate sex

```{r}
long_accel_df =
  merged_df |> 
  pivot_longer(
    cols = starts_with("min"),
    names_to = "minute",
    names_prefix = "min",
    values_to = "activity_level"
  ) |> 
  group_by(minute, sex, education) |> 
  mutate(
    hour = as.numeric(sub("min", "", minute)) / 60 
  )
```


```{r}
 time_course_plot =
  long_accel_df |> 
   ggplot(aes(x = hour, y = activity_level, color = sex)) +
   geom_line(alpha = 0.1) + 
   geom_smooth(se = FALSE) + 
   facet_wrap(~ education) + 
   labs(
        title = "24-Hour Activity Time Course by Education Level and Sex",
        x = "Time of Day (hours)",
        y = "Activity Level",
        color = "Sex") +
   theme_minimal()

print(time_course_plot)
```

Describe:
1. From the plot, we can see that the overall activity level is low during the early morning hours, and during the day it increases, at the middle of the day comes to a peak, and gradually decreases towards the evening and night.
2. For all education levels, males and females show similar activity trends throughout the whole day.

## Problem 3

import and clean 4 dataset
 combine all the 4 datasets
```{r}
 jan20_df = 
   read_csv("data/Jan 2020 Citi.csv", na = c("NA",".","")) |> 
   janitor::clean_names()

 jan24_df = 
   read_csv("data/Jan 2024 Citi.csv", na = c("NA",".","")) |> 
   janitor::clean_names()

 july20_df = 
   read_csv("data/July 2020 Citi.csv", na = c("NA",".","")) |> 
   janitor::clean_names()

 july24_df = 
   read_csv("data/July 2024 Citi.csv", na = c("NA",".","")) |> 
   janitor::clean_names()
 
 citibike_df = 
   bind_rows(
   jan20_df |> 
     mutate(month = "January", year = 2020),
   jan24_df |>
     mutate(month = "January", year = 2024),
   july20_df |> 
     mutate(month = "July", year = 2020),
   july24_df |> 
     mutate(month = "July", year = 2024)
   )
```

Discribe: first I imported these 4 datasets with 2020 and 2024 January and July data, then I combined these 4 datasets with Month and Year variables for each. The final "citibike_df" contains 99485 observations and 9 variables, that provide  ride_id, rideable_type, weekdays, duration, start_station_name, end_station_name, member_casual, month, and year.


Produce a reader-friendly table showing the total number of rides in each combination of year and month separating casual riders and Citi Bike members.
```{r}
 ride_counts =
   citibike_df |> 
   group_by(year, month, member_casual) |> 
   summarise(total_rides = n()) |> 
   pivot_wider(names_from = member_casual, values_from = total_rides) |>
   knitr::kable()

 ride_counts
```

Comment: from the result, we know that all of the member riders have a higher frequency than the casual riders. The number of total rides for members is increasing from 2020 Jan to 2024 July. For casual riders, the total rides in 2020 kept increasing, but in 2024 Jan decreased then in 2024 July increased again.
  
  
Make a table showing the 5 most popular starting stations for July 2024; include the number of rides originating from these stations. 
The table in the following shows the the 5 most popular starting stations for July 2024.
```{r}
 top_stations_july24 =
   july24_df |> 
   group_by(start_station_name) |> 
   summarise(total_rides = n(), .groups = "drop") |> 
   arrange(desc(total_rides)) |> 
   slice_head(n = 5) |> 
   knitr::kable()

 top_stations_july24
```


Make a plot to investigate the effects of day of the week, month, and year on median ride duration. 

```{r}
 median_duration_df =
   citibike_df |> 
   mutate(weekdays = factor(weekdays, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))) |>
   group_by(year, month, weekdays) |>
   summarize(median_duration = median(duration), .groups = "drop")
  
 duration_plot =
   median_duration_df |> 
   ggplot(aes(x = weekdays, y = median_duration, group = month, color = month)) +
   geom_line() + 
   facet_grid(. ~ year) + 
   labs(
     title = "Median Ride Duration by Day of the Week, Month, and Year",
     x = "Day of the Week",
     y = "Median Duration (in minutes)") +
   theme_minimal() +
   theme(axis.text.x = element_text(angle = 45), 
         legend.position = "bottom") 

 duration_plot
```

Comment: 
1. Compared to weekdays, the median ride duration is longer on weekends in 2020. For each year, July has a longer median ride duration than January.
2. In 2024, the median ride duration on Sunday drops compared to Saturday.
3. 2024 has a shorter median ride duration than 2020 in both January and July.


For data in 2024, make a figure that shows the impact of month, membership status, and bike type on the distribution of ride duration

```{r}
 citibike24_df = 
   citibike_df|> 
   filter(year == 2024)

 citibike24_df |> 
   ggplot(aes(x = duration, fill = rideable_type)) +
   geom_density(alpha = 0.5) +
   facet_grid(month ~ member_casual) +
   labs(x = "Ride Duration (minutes)", y = "Density") +
   theme_minimal()
```

Make another density plot to focus more closely on the relevant parts of the data

```{r}
 citibike24_df |> 
  ggplot(aes(x = duration, fill = rideable_type)) +
  geom_density(alpha = 0.5, trim = TRUE) + 
  facet_grid(month ~ member_casual) + 
  labs(
    x = "Ride Duration (minutes)", 
    y = "Density", 
    title = "Distribution of Ride Duration by Bike Type, Membership, and Month") +
  theme_minimal() +
  scale_x_continuous(limits = c(0, 100)) 
```

Comment: 
1. Both class and electric bikes show a peak that usually in ride duration within 30 minutes. This means that most rides, regardless of bike type or user membership, are relatively short.
2. Electric bikes tend to have a slightly longer ride duration compared to classic bikes.
3. Members tend to use classic bikes more consistently, with their distribution being sharper and more centered around shorter durations.


